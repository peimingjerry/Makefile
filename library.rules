
.PHONY: depend

# Define library names
LIB_NAME := $(strip $(LIB_NAME))
LIB_ARCHIVE_NAME := lib$(LIB_NAME).a
LIB_ARCHIVE := $(OBJ_DIR)/$(LIB_ARCHIVE_NAME)

LIB_OBJ := $(patsubst %.c, %.o, $(LIB_SRC))
LIB_OBJ := $(addprefix $(OBJ_DIR)/, $(LIB_OBJ))

# Rule to build library. Should be placed on the top of this file.
$(LIB_ARCHIVE): $(LIB_OBJ)
	$(WHISPER) $(ECHO) "Creating $(LIB_ARCHIVE) ($(OPTTYPE))"
	$(WHISPER) $(RM) $@
	$(WHISPER) $(AR) $@ $+
	$(WHISPER) $(ECHO) "$(LIB_ARCHIVE_NAME) Done!"

# Define dependencies files.
LIB_DEP		:= $(addprefix $(OBJ_DIR)/, $(addsuffix .depend, $(LIB_NAME)))
LIB_DEP_FILES	:= $(patsubst %.c, %.d, $(LIB_SRC))
LIB_DEP_FILES 	:= $(addprefix $(OBJ_DIR)/, $(LIB_DEP_FILES))

# Generate dependencies file for each library.
depend: $(LIB_DEP)
$(LIB_DEP): $(LIB_DEP_FILES)
	$(WHISPER) $(ECHO) "Generating dependencies for library $(LIB_NAME)"; \
	$(RM) $@ ; \
	$(ECHO) '# This file is automatically generated.' > $@; \
	for f in `echo $+` ; \
	    do \
	    	$(ECHO) "-include $$f" >> $@; \
	    done

# Include dependencies
#TODO: do not include it when cleanning...
-include $(LIB_DEP)

# Clean up libraries
clean:
	$(WHISPER) $(ECHO) "Cleaning" $(LIB_NAME)
	$(RM) $(LIB_OBJ) $(LIB_ARCHIVE) $(LIB_DEP_FILES) $(LIB_DEP)

